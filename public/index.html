<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test</title>
</head>
<body>
    <button onclick="startTest()">Start Speed Test</button>
    <div id="result"></div>

    <script>
        async function startTest() {
            const resultDiv = document.getElementById('result');
            const testDuration = 10 * 1000; // 10 seconds
    
            const startTestTime = Date.now();
    
            // Pingテスト
            const pingTimes = [];
            const endPingTime = Date.now() + 3 * 1000;
    
            while (Date.now() < endPingTime) {
                const startPing = Date.now();
                await fetch('/ping');
                const pingTime = Date.now() - startPing;
                pingTimes.push(pingTime);
                const averagePingTime = pingTimes.reduce((a, b) => a + b, 0) / pingTimes.length;
                updateDisplay(averagePingTime, null, 0, null, 0);
                await new Promise(resolve => setTimeout(resolve, 10));
            }
    
            const averagePingTime = pingTimes.reduce((a, b) => a + b, 0) / pingTimes.length;
    
            async function downloadTest(testDuration, startTestTime, averagePingTime) {
                let totalDownloadedBytes = 0;
                const endDownloadTime = Date.now() + testDuration;
    
                while (Date.now() < endDownloadTime) {
                    const response = await fetch('/download');
                    const reader = response.body.getReader();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        totalDownloadedBytes += value.length;
                        const currentDownloadSpeed = (totalDownloadedBytes * 8) / ((Date.now() - startTestTime) / 1000); // bits per second
                        updateDisplay(averagePingTime, currentDownloadSpeed, totalDownloadedBytes, null, 0);
                    }
                }
                const downloadTime = Date.now() - startTestTime - 3 * 1000; // total time minus ping test duration
                return (totalDownloadedBytes * 8) / (downloadTime / 1000); // bits per second
            }
    
            async function uploadTest(testDuration, startTestTime, downloadSpeed, averagePingTime) {
                let totalUploadedBytes = 0;
                const endUploadTime = Date.now() + testDuration;
                const uploadedSizes = [];
    
                while (Date.now() < endUploadTime) {
                    const randomSize = Math.floor(Math.random() * (100 * 1024 * 1024 - 1024 + 1) + 1024);
                    const uploadData = new Uint8Array(randomSize).fill(0);
                    await fetch('/upload', {
                        method: 'POST',
                        body: uploadData
                    });
                    uploadedSizes.push(randomSize);
                    totalUploadedBytes += randomSize;
                    const currentUploadSpeed = (totalUploadedBytes * 8) / ((Date.now() - startTestTime - 3 * 1000) / 1000);
                    updateDisplay(averagePingTime, downloadSpeed, totalUploadedBytes, currentUploadSpeed, totalUploadedBytes);
                }
                const uploadTime = Date.now() - startTestTime - 3 * 1000;
                return (totalUploadedBytes * 8) / (uploadTime / 1000); // bits per second
            }
    
            const downloadSpeed = await downloadTest(testDuration, startTestTime, averagePingTime);
            const uploadSpeed = await uploadTest(testDuration, startTestTime, downloadSpeed, averagePingTime);
    
            console.log(`Download speed: ${downloadSpeed} bps, Upload speed: ${uploadSpeed} bps`);
    
            function updateDisplay(ping, downloadSpeed, downloadedData, uploadSpeed, uploadedData) {
                resultDiv.innerHTML = `
                    <p>Ping: ${ping ? ping.toFixed(2) + 'ms' : 'Calculating...'}</p>
                    <p>Download speed: ${downloadSpeed ? formatSpeed(downloadSpeed) : 'Calculating...'} | Data: ${formatSize(downloadedData)}</p>
                    <p>Upload speed: ${uploadSpeed ? formatSpeed(uploadSpeed) : 'Calculating...'} | Data: ${formatSize(uploadedData)}</p>
                `;
            }
    
            function formatSpeed(bitsPerSecond) {
                if (bitsPerSecond < 1e6) {
                    return (bitsPerSecond / 1e3).toFixed(2) + ' Kbps';
                } else if (bitsPerSecond < 1e9) {
                    return (bitsPerSecond / 1e6).toFixed(2) + ' Mbps';
                } else {
                    return (bitsPerSecond / 1e9).toFixed(2) + ' Gbps';
                }
            }
    
            function formatSize(bytes) {
                if (bytes < 1e6) {
                    return Math.floor(bytes / 1e3) + ' KB';
                } else if (bytes < 1e9) {
                    return Math.floor(bytes / 1e6) + ' MB';
                } else {
                    return (bytes / 1e9).toFixed(1) + ' GB';
                }
            }
        }
    </script>
</body>
</html>
